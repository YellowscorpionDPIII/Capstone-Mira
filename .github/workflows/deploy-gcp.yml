name: Deploy to GCP

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

# Restrict permissions for security
permissions:
  contents: read
  id-token: write

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ secrets.GCP_REGION }}
  SERVICE_NAME: mira-app
  GAR_LOCATION: ${{ secrets.GCP_REGION }}
  REPOSITORY: mira-repo

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e ".[dev]"
    
    - name: Run tests with coverage
      run: |
        python -m pytest mira/tests/ --benchmark-disable

  build-and-deploy:
    runs-on: ubuntu-latest
    needs: test
    # Only deploy on push to main/master, not on PRs
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions:
      contents: read
      id-token: write
    
    steps:
    - uses: actions/checkout@v4
    
    # Authenticate to Google Cloud using Workload Identity Federation (recommended)
    - name: Authenticate to Google Cloud
      id: auth
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
        service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
    
    # Alternative: Authenticate using Service Account Key (if not using Workload Identity)
    # - name: Authenticate to Google Cloud (Service Account Key)
    #   uses: google-github-actions/auth@v2
    #   with:
    #     credentials_json: ${{ secrets.GCP_SA_KEY }}
    
    # Set up Cloud SDK
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
    
    # Configure Docker to use Google Artifact Registry
    - name: Configure Docker for Artifact Registry
      run: |
        gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev
    
    # Build Docker image
    - name: Build Docker image
      run: |
        docker build -t ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:${{ github.sha }} \
                     -t ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:latest \
                     .
    
    # Push Docker image to Google Artifact Registry
    - name: Push Docker image to Artifact Registry
      run: |
        docker push ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:${{ github.sha }}
        docker push ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:latest
    
    # Deploy to Cloud Run
    - name: Deploy to Cloud Run
      id: deploy
      uses: google-github-actions/deploy-cloudrun@v2
      with:
        service: ${{ env.SERVICE_NAME }}
        region: ${{ env.REGION }}
        image: ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:${{ github.sha }}
        flags: |
          --port=5000
          --cpu=1
          --memory=512Mi
          --min-instances=0
          --max-instances=10
          --timeout=300
          --allow-unauthenticated
        env_vars: |
          ENVIRONMENT=production
        secrets: |
          TRELLO_API_KEY=trello-api-key:latest
          TRELLO_API_TOKEN=trello-api-token:latest
          JIRA_API_TOKEN=jira-api-token:latest
          GITHUB_TOKEN=github-token:latest
          AIRTABLE_API_KEY=airtable-api-key:latest
          GOOGLE_DOCS_CREDENTIALS=google-docs-credentials:latest
          WEBHOOK_SECRET_KEY=webhook-secret-key:latest
    
    # Show deployment URL
    - name: Show deployment URL
      run: |
        echo "Service deployed to: ${{ steps.deploy.outputs.url }}"
    
    # Run smoke test against deployed service
    - name: Smoke test
      run: |
        sleep 10
        curl -f ${{ steps.deploy.outputs.url }}/health || echo "Warning: Health check endpoint not available"
